name: Sync Country IP Ranges to Discord

on:
  schedule:
    - cron: '0 * * * *' # ุงุฌุฑุง ุฎูุฏฺฉุงุฑ ุณุฑ ูุฑ ุณุงุนุช
  workflow_dispatch: # ุงูฺฉุงู ุงุฌุฑุง ุฏุณุช ุจุฑุง ุชุณุช

jobs:
  update-and-notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with ebrasha/cidr-ip-ranges
        run: |
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git
          git fetch upstream
          git checkout main
          
          # ุจุฑุฑุณ ุงูฺฉู ุขุง ุชุบุฑ ุฌุฏุฏ ุฏุฑ ูพุฑูฺู ุงุตู ูุฌูุฏ ุฏุงุฑุฏ ุง ุฎุฑ
          if git merge upstream/main --ff-only; then
            echo "sync_status=updated" >> $GITHUB_ENV
            git push origin main
          else
            echo "sync_status=no_change" >> $GITHUB_ENV
          fi

      - name: Send Updates to Discord
        if: env.sync_status == 'updated'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # ูพุฏุง ฺฉุฑุฏู ูุณุช ูุงูโูุง ูุชู ฺฉู ุฏุฑ ุขุฎุฑู ุณูฺฉ ุชุบุฑ ฺฉุฑุฏูโุงูุฏ
          # ุงู ุฏุณุชูุฑ ููุท ูุงูโูุง ฺฉู ุฏุฑ ูพูุดู iplists ูุณุชูุฏ ุฑุง ฺฺฉ ูโฺฉูุฏ
          CHANGED_FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$')
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "ุชุบุฑ ูุญุชูุง ุฏุฑ ูุงูโูุง txt ูุฌูุฏ ูุฏุงุดุช."
            exit 0
          fi

          for FILE in $CHANGED_FILES; do
            # ุฎูุงูุฏู ฒฐ ุฎุท ุงูู ูุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุทููุงู ุดุฏู ูพุงู ุฏุณฺฉูุฑุฏ
            CONTENT=$(head -n 20 "$FILE")
            FILE_NAME=$(basename "$FILE")
            
            echo "ุงุฑุณุงู ุขูพุฏุช ูุงู: $FILE_NAME"
            
            curl -H "Content-Type: application/json" \
                 -d "{\"content\": \"๐ฉ **ุชุบุฑ ุฏุฑ ุฑูุฌ ุขโูพ: $FILE_NAME**\n\`\`\`\n$CONTENT\n\n... (ุงุฏุงูู ุฏุฑ ูุงู ุงุตู)\n\`\`\`\"}" \
                 $DISCORD_WEBHOOK
          done
