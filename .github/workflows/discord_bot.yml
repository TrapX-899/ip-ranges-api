name: Country IP Sync & Final Clean Links
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Send Mission Start Header
        if: github.event_name == 'workflow_dispatch' || env.updated == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          TZ='Asia/Tehran'
          START_TIME=$(date +'%H:%M:%S')
          
          # Ú©Ø¯ Ø±Ù…Ø²Ù‡Ø§ (ØªØ±Ú©ÛŒØ¨ÛŒ Ø§Ø² Ù¾Ø¯Ø§ÙÙ†Ø¯ Ù‡Ø§)
          CODENAMES=("S400-TRIUMF" "BAVAR-373-CORE" "PATRIOT-STRIKE" "V12-IRON-CLAD" "THOR-RADAR")
          SELECTED_CODE=${CODENAMES[$RANDOM % ${#CODENAMES[@]}]}

          START_MSG="ğŸš€ **NEW OPERATION INITIATED**"$'\n'
          START_MSG+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"$'\n'
          START_MSG+="  ğŸ“¡ **UNIT:** \`Bavar-373-Radar-Station\`"$'\n'
          START_MSG+="  ğŸ›¡ï¸ **CODENAME:** \`$SELECTED_CODE\`"$'\n'
          START_MSG+="  â° **TIME:** \`$START_TIME\`"$'\n'
          START_MSG+="â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"$'\n'
          START_MSG+="*Scanning for Intelligence Data...* ğŸ“¥"

          jq -n --arg msg "$START_MSG" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master || git checkout main
          if git merge upstream/master --ff-only || git merge upstream/main --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin HEAD
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ (ÙÙ‚Ø· IPv4)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find CIDR/ -name "*-ipv4-*" | grep -v "ipv6" | sort)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep "CIDR/" | grep "ipv4" | grep -v "ipv6" || true)
          else
            echo "ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."
            exit 0
          fi

          if [ -z "$FILES" ]; then
            echo "Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."
            exit 0
          fi

          MESSAGE=""
          COUNT=0

          for FILE in $FILES; do
            FILE_NAME=$(basename "$FILE")
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø¯ Ø¯Ùˆ Ø±Ù‚Ù…ÛŒ Ú©Ø´ÙˆØ± (Ù…Ø«Ù„Ø§ TH ÛŒØ§ IR)
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            
            # ØªØ¨Ø¯ÛŒÙ„ Ú©Ø¯ Ú©Ø´ÙˆØ± Ø¨Ù‡ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ù¾Ø±Ú†Ù… (Regional Indicator Symbols)
            # Ø§ÛŒÙ† Ø¨Ø®Ø´ Ú©Ø¯ Ù‡Ú¯Ø² Ú©Ø¯ Ú©Ø´ÙˆØ± Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ…ÙˆØ¬ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            EMOJI=$(python3 -c "print(''.join(chr(127397 + ord(c)) for c in '$CODE'))" 2>/dev/null || echo "ğŸŒ")

            # Ù†Ø§Ù… Ú©Ø´ÙˆØ±Ù‡Ø§
            # Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ú©Ø´ÙˆØ±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ø¯Ùˆ Ø±Ù‚Ù…ÛŒ
            case $CODE in
              AF) NAME="Afghanistan" ;; AL) NAME="Albania" ;; DZ) NAME="Algeria" ;; AS) NAME="American Samoa" ;; AD) NAME="Andorra" ;; AO) NAME="Angola" ;; AI) NAME="Anguilla" ;; AQ) NAME="Antarctica" ;; AG) NAME="Antigua/Barbuda" ;; AR) NAME="Argentina" ;; AM) NAME="Armenia" ;; AW) NAME="Aruba" ;; AU) NAME="Australia" ;; AT) NAME="Austria" ;; AZ) NAME="Azerbaijan" ;;
              BS) NAME="Bahamas" ;; BH) NAME="Bahrain" ;; BD) NAME="Bangladesh" ;; BB) NAME="Barbados" ;; BY) NAME="Belarus" ;; BE) NAME="Belgium" ;; BZ) NAME="Belize" ;; BJ) NAME="Benin" ;; BM) NAME="Bermuda" ;; BT) NAME="Bhutan" ;; BO) NAME="Bolivia" ;; BA) NAME="Bosnia" ;; BW) NAME="Botswana" ;; BR) NAME="Brazil" ;; BN) NAME="Brunei" ;; BG) NAME="Bulgaria" ;; BF) NAME="Burkina Faso" ;; BI) NAME="Burundi" ;;
              KH) NAME="Cambodia" ;; CM) NAME="Cameroon" ;; CA) NAME="Canada" ;; CV) NAME="Cape Verde" ;; KY) NAME="Cayman Islands" ;; CF) NAME="Central African Rep" ;; TD) NAME="Chad" ;; CL) NAME="Chile" ;; CN) NAME="China" ;; CX) NAME="Christmas Island" ;; CC) NAME="Cocos Islands" ;; CO) NAME="Colombia" ;; KM) NAME="Comoros" ;; CG) NAME="Congo" ;; CD) NAME="Congo (DRC)" ;; CK) NAME="Cook Islands" ;; CR) NAME="Costa Rica" ;; CI) NAME="Ivory Coast" ;; HR) NAME="Croatia" ;; CU) NAME="Cuba" ;; CY) NAME="Cyprus" ;; CZ) NAME="Czech Republic" ;;
              DK) NAME="Denmark" ;; DJ) NAME="Djibouti" ;; DM) NAME="Dominica" ;; DO) NAME="Dominican Rep" ;; EC) NAME="Ecuador" ;; EG) NAME="Egypt" ;; SV) NAME="El Salvador" ;; GQ) NAME="Equatorial Guinea" ;; ER) NAME="Eritrea" ;; EE) NAME="Estonia" ;; ET) NAME="Ethiopia" ;; FK) NAME="Falkland Islands" ;; FO) NAME="Faroe Islands" ;; FJ) NAME="Fiji" ;; FI) NAME="Finland" ;; FR) NAME="France" ;; GF) NAME="French Guiana" ;; PF) NAME="French Polynesia" ;;
              GA) NAME="Gabon" ;; GM) NAME="Gambia" ;; GE) NAME="Georgia" ;; DE) NAME="Germany" ;; GH) NAME="Ghana" ;; GI) NAME="Gibraltar" ;; GR) NAME="Greece" ;; GL) NAME="Greenland" ;; GD) NAME="Grenada" ;; GP) NAME="Guadeloupe" ;; GU) NAME="Guam" ;; GT) NAME="Guatemala" ;; GG) NAME="Guernsey" ;; GN) NAME="Guinea" ;; GW) NAME="Guinea-Bissau" ;; GY) NAME="Guyana" ;; HT) NAME="Haiti" ;; HN) NAME="Honduras" ;; HK) NAME="Hong Kong" ;; HU) NAME="Hungary" ;; IS) NAME="Iceland" ;; IN) NAME="India" ;; ID) NAME="Indonesia" ;; IR) NAME="Iran" ;; IQ) NAME="Iraq" ;; IE) NAME="Ireland" ;; IM) NAME="Isle of Man" ;; IL) NAME="Israel" ;; IT) NAME="Italy" ;;
              JM) NAME="Jamaica" ;; JP) NAME="Japan" ;; JE) NAME="Jersey" ;; JO) NAME="Jordan" ;; KZ) NAME="Kazakhstan" ;; KE) NAME="Kenya" ;; KI) NAME="Kiribati" ;; KP) NAME="North Korea" ;; KR) NAME="South Korea" ;; KW) NAME="Kuwait" ;; KG) NAME="Kyrgyzstan" ;; LA) NAME="Laos" ;; LV) NAME="Latvia" ;; LB) NAME="Lebanon" ;; LS) NAME="Lesotho" ;; LR) NAME="Liberia" ;; LY) NAME="Libya" ;; LI) NAME="Liechtenstein" ;; LT) NAME="Lithuania" ;; LU) NAME="Luxembourg" ;;
              MO) NAME="Macao" ;; MK) NAME="Macedonia" ;; MG) NAME="Madagascar" ;; MW) NAME="Malawi" ;; MY) NAME="Malaysia" ;; MV) NAME="Maldives" ;; ML) NAME="Mali" ;; MT) NAME="Malta" ;; MH) NAME="Marshall Islands" ;; MQ) NAME="Martinique" ;; MR) NAME="Mauritania" ;; MU) NAME="Mauritius" ;; YT) NAME="Mayotte" ;; MX) NAME="Mexico" ;; FM) NAME="Micronesia" ;; MD) NAME="Moldova" ;; MC) NAME="Monaco" ;; MN) NAME="Mongolia" ;; ME) NAME="Montenegro" ;; MS) NAME="Montserrat" ;; MA) NAME="Morocco" ;; MZ) NAME="Mozambique" ;; MM) NAME="Myanmar" ;;
              NA) NAME="Namibia" ;; NR) NAME="Nauru" ;; NP) NAME="Nepal" ;; NL) NAME="Netherlands" ;; NC) NAME="New Caledonia" ;; NZ) NAME="New Zealand" ;; NI) NAME="Nicaragua" ;; NE) NAME="Niger" ;; NG) NAME="Nigeria" ;; NU) NAME="Niue" ;; NF) NAME="Norfolk Island" ;; MP) NAME="Northern Mariana" ;; NO) NAME="Norway" ;; OM) NAME="Oman" ;; PK) NAME="Pakistan" ;; PW) NAME="Palau" ;; PS) NAME="Palestine" ;; PA) NAME="Panama" ;; PG) NAME="Papua New Guinea" ;; PY) NAME="Paraguay" ;; PE) NAME="Peru" ;; PH) NAME="Philippines" ;; PL) NAME="Poland" ;; PT) NAME="Portugal" ;; PR) NAME="Puerto Rico" ;;
              QA) NAME="Qatar" ;; RE) NAME="Reunion" ;; RO) NAME="Romania" ;; RU) NAME="Russia" ;; RW) NAME="Rwanda" ;; SH) NAME="Saint Helena" ;; KN) NAME="Saint Kitts/Nevis" ;; LC) NAME="Saint Lucia" ;; PM) NAME="Saint Pierre" ;; VC) NAME="Saint Vincent" ;; WS) NAME="Samoa" ;; SM) NAME="San Marino" ;; ST) NAME="Sao Tome" ;; SA) NAME="Saudi Arabia" ;; SN) NAME="Senegal" ;; RS) NAME="Serbia" ;; SC) NAME="Seychelles" ;; SL) NAME="Sierra Leone" ;; SG) NAME="Singapore" ;; SK) NAME="Slovakia" ;; SI) NAME="Slovenia" ;; SB) NAME="Solomon Islands" ;; SO) NAME="Somalia" ;; ZA) NAME="South Africa" ;; ES) NAME="Spain" ;; LK) NAME="Sri Lanka" ;; SD) NAME="Sudan" ;; SR) NAME="Suriname" ;; SZ) NAME="Swaziland" ;; SE) NAME="Sweden" ;; CH) NAME="Switzerland" ;; SY) NAME="Syria" ;;
              TW) NAME="Taiwan" ;; TJ) NAME="Tajikistan" ;; TZ) NAME="Tanzania" ;; TH) NAME="Thailand" ;; TL) NAME="Timor-Leste" ;; TG) NAME="Togo" ;; TK) NAME="Tokelau" ;; TO) NAME="Tonga" ;; TT) NAME="Trinidad" ;; TN) NAME="Tunisia" ;; TR) NAME="Turkey" ;; TM) NAME="Turkmenistan" ;; TC) NAME="Turks/Caicos" ;; TV) NAME="Tuvalu" ;; UG) NAME="Uganda" ;; UA) NAME="Ukraine" ;; AE) NAME="UAE" ;; GB) NAME="United Kingdom" ;; US) NAME="USA" ;; UY) NAME="Uruguay" ;; UZ) NAME="Uzbekistan" ;; VU) NAME="Vanuatu" ;; VA) NAME="Vatican City" ;; VE) NAME="Venezuela" ;; VN) NAME="Vietnam" ;; VG) NAME="Virgin Islands (UK)" ;; VI) NAME="Virgin Islands (US)" ;; WF) NAME="Wallis/Futuna" ;; EH) NAME="Western Sahara" ;; YE) NAME="Yemen" ;; ZM) NAME="Zambia" ;; ZW) NAME="Zimbabwe" ;;
              *) NAME="$CODE" ;;
            esac

            FULL_URL="${REPO_BASE_URL}/$FILE"
            LINE="$EMOJI **$NAME**: <$FULL_URL>"
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="$LINE"
            else
              MESSAGE="$MESSAGE"$'\n'"$LINE"
            fi
            
            COUNT=$((COUNT + 1))

            # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ 15 ØªØ§ÛŒÛŒ
            if [ $COUNT -eq 15 ]; then
              jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
              MESSAGE=""
              COUNT=0
              sleep 1 # ÙˆÙ‚ÙÙ‡ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ù„Ø§Ú© Ø´Ø¯Ù† ØªÙˆØ³Ø· Ø¯ÛŒØ³Ú©ÙˆØ±Ø¯
            fi
          done

          # Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
          if [ $COUNT -gt 0 ]; then
            jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi

      - name: Send Final Status & Analytics
        if: github.event_name == 'workflow_dispatch' || env.updated == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # ØªÙ†Ø¸ÛŒÙ… Ø³Ø§Ø¹Øª Ø¨Ù‡ ÙˆÙ‚Øª Ø§ÛŒØ±Ø§Ù†
          TZ='Asia/Tehran'
          LAST_UPDATE=$(date +'%Y/%m/%d - %H:%M')

          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ (Ù†Ù‡ ÙÙ‚Ø· ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡â€ŒÙ‡Ø§)
          FILES=$(find CIDR/ -name "*-ipv4-*" | grep -v "ipv6" | sort)
          
          # Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø´ÙˆØ±Ù‡Ø§
          COUNTRY_COUNT=$(echo "$FILES" | grep -v '^$' | wc -l)
          
          # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø®Ø·ÙˆØ· (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ù†Ø¬â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒâ€ŒÙ¾ÛŒ)
          TOTAL_IPS=0
          while read -r f; do
            if [ -f "$f" ]; then
              LINES=$(wc -l < "$f")
              TOTAL_IPS=$((TOTAL_IPS + LINES))
            fi
          done <<< "$FILES"

          # Ø¬Ù…Ù„Ø§Øª ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ (Ø±Ù†Ø¯ÙˆÙ… Ù†Ø¸Ø§Ù…ÛŒ)
          FINAL_QUOTES=("Mission Accomplished. Base Secured." "Intelligence Gathering Complete." "All Units Returned to Hangar." "V12 Engine Cooling Down.")
          RANDOM_QUOTE=${FINAL_QUOTES[$RANDOM % ${#FINAL_QUOTES[@]}]}

          # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ
          FINAL_REPORT="ğŸ **IP RANGE FINDING MISSION SUMMARY**"$'\n'
          FINAL_REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"$'\n'
          FINAL_REPORT+="ğŸ“… **Last Update (IRAN-TIME):** \`$LAST_UPDATE\`"$'\n'
          FINAL_REPORT+="ğŸŒ **Total Countries in Database:** \`$COUNTRY_COUNT\`"$'\n'
          FINAL_REPORT+="ğŸ”¢ **Total Active IP Ranges:** \`$TOTAL_IPS\`"$'\n'
          FINAL_REPORT+="ğŸ“ **Operation Status:** \`$RANDOM_QUOTE\`"$'\n'
          FINAL_REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¯ÛŒØ³Ú©ÙˆØ±Ø¯
          jq -n --arg msg "$FINAL_REPORT" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
