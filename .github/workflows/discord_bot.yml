name: Country IP Sync - Final Version

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù†Ø§Ù… Ùˆ Ù¾Ø±Ú†Ù… Ú©Ø´ÙˆØ±Ù‡Ø§
          curl -s https://raw.githubusercontent.com/stefangabos/world_countries/master/data/en/countries.json -o countries.json

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find . -name "*.txt" | grep "CIDR/" | grep -v "ipv6" | head -n 100)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' | grep -v "ipv6" || true)
          else
            echo "ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."
            exit 0
          fi

          MESSAGE=""
          COUNT=0

          for FILE in $FILES; do
            FILE_NAME=$(basename "$FILE")
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:upper:]' '[:lower:]')
            
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø§Ù… Ùˆ Ù¾Ø±Ú†Ù… Ø§Ø² ÙØ§ÛŒÙ„ JSON
            # Ø§Ø² Ú©Ø¯ Û² Ø­Ø±ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ùˆ Ù¾Ø±Ú†Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            COUNTRY_DATA=$(jq -r --arg code "$CODE" '.[] | select(.alpha2 == $code) | "\(.emoji) \(.name)"' countries.json)
            
            # Ø§Ú¯Ø± Ú©Ø´ÙˆØ± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ÙÙ‚Ø· Ú©Ø¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
            if [ -z "$COUNTRY_DATA" ]; then COUNTRY_DATA="ğŸŒ Country: ${CODE^^}"; fi

            FULL_URL="${REPO_BASE_URL}/CIDR/${FILE_NAME}"
            
            # Ø³Ø§Ø®Øª Ø®Ø· Ù¾ÛŒØ§Ù…: Ù†Ø§Ù… Ùˆ Ù¾Ø±Ú†Ù… + Ù„ÛŒÙ†Ú© Ø¨Ø¯ÙˆÙ† Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø®Ù„ <>
            LINE="${COUNTRY_DATA}: <${FULL_URL}>"
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="$LINE"
            else
              MESSAGE="$MESSAGE"$'\n'"$LINE"
            fi
            
            COUNT=$((COUNT + 1))

            # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Û±Û° ØªØ§ÛŒÛŒ
            if [ $COUNT -eq 10 ]; then
              jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -s -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
              MESSAGE=""
              COUNT=0
              sleep 2
            fi
          done

          if [ $COUNT -gt 0 ]; then
            jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -s -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
