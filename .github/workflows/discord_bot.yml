name: Country IP Sync & Multi-Mode Discord

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-send:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Process and Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # ุจุฑุฑุณ ูุฌูุฏ ูุจโููฺฉ
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "ุฎุทุง: ูุจโููฺฉ ุฏุณฺฉูุฑุฏ ุฏุฑ Secrets ุชุนุฑู ูุดุฏู ุงุณุช!"
            exit 1
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ุงุฌุฑุง ุฏุณุช: ุฏุฑ ุญุงู ุฌุณุชุฌู ุชูุงู ูุงูโูุง txt..."
            # ุฌุณุชุฌู ุนููโุชุฑ ุจุฑุง ุงูุชู ูุงูโูุง ุฏุฑ ุชูุงู ูพูุดูโูุง
            FILES=$(find . -maxdepth 3 -name "*.txt" | head -n 5)
          elif [[ "$updated" == "true" ]]; then
            echo "ุงุฌุฑุง ุฎูุฏฺฉุงุฑ: ุจุฑุฑุณ ุชุบุฑุงุช..."
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' || true)
          else
            echo "ุชุบุฑ ุฌุฏุฏ ูุจูุฏ."
            exit 0
          fi

          for FILE in $FILES; do
            # ุญุฐู ./ ุงุฒ ุงุจุชุฏุง ูุงู ูุงู ุจุฑุง ุฒุจุง
            CLEAN_NAME=$(echo $FILE | sed 's|./||')
            echo "ุงุฑุณุงู ูุงู: $CLEAN_NAME"
            
            # ุฎูุงูุฏู ูุญุชูุง ู ุขูุงุฏูโุณุงุฒ ุจุฑุง JSON (ุญุฐู ฺฉุงุฑุงฺฉุชุฑูุง ุบุฑูุฌุงุฒ)
            CONTENT=$(head -n 15 "$FILE" | tr -d '"' | tr -d '\r')
            
            curl -H "Content-Type: application/json" \
                 -d "{\"content\": \"๐ **ุชุณุช ุงุฑุณุงู ูุงู**\n๐ ูุงู ูุงู: \`$CLEAN_NAME\`\n\`\`\`\n$CONTENT\n\`\`\`\"}" \
                 "$DISCORD_WEBHOOK"
            
            sleep 1
          done
