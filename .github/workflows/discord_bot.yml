name: Country IP Sync & Final Clean Links
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master || git checkout main
          if git merge upstream/master --ff-only || git merge upstream/main --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin HEAD
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

- name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          # ุงุณุชุฎุฑุงุฌ ูุงูโูุง ู ูุฑุชุจโุณุงุฒ ุญุฑูู ุงููุจุง ุจุฑุง ุญูุธ ุชุฑุชุจ
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find CIDR/ -name "*-ipv4-*" | grep -v "ipv6" | sort)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep "CIDR/" | grep "ipv4" | grep -v "ipv6" | sort || true)
          else
            echo "ุชุบุฑ ุฌุฏุฏ ุงูุช ูุดุฏ."
            exit 0
          fi

          if [ -z "$FILES" ]; then
            echo "ูุณุช ูุงูโูุง ุฎุงู ุงุณุช."
            exit 0
          fi

          # ุฏุชุงุจุณ ูุถุนุชโูุง ูุธุงู/ูู
          MILITARY_STATUS=(
            "๐ก Radar Scan: Completed. No threats detected."
            "๐ก๏ธ Perimeter Secured: IP database synchronized."
            "โก Targeting Systems: Calibrated and Ready."
            "๐ฆ Air Reconnaissance: Data feed established."
            "โ๏ธ V12 Engine: Peak performance maintained."
            "๐ป Encrypted Channel: Transmission successful."
            "๐ Stealth Mode: Operational."
          )
          RANDOM_STATUS=${MILITARY_STATUS[$RANDOM % ${#MILITARY_STATUS[@]}]}

          MESSAGE="--- ๐๏ธ **INTELLIGENCE UPDATE** ---"$'\n'
          COUNT=0
          TOTAL=$(echo "$FILES" | wc -l)
          CURRENT=0

          for FILE in $FILES; do
            CURRENT=$((CURRENT + 1))
            FILE_NAME=$(basename "$FILE")
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            
            # ุชุจุฏู ฺฉุฏ ฺฉุดูุฑ ุจู ุงููุฌ ูพุฑฺู
            EMOJI=$(python3 -c "print(''.join(chr(127397 + ord(c)) for c in '$CODE'))" 2>/dev/null || echo "๐")

            # ุฏฺฉุดูุฑ ูุงู ฺฉุดูุฑูุง (ฺฉุฏ ุงุฑุณุงู ุฎูุฏุชุงู)
            case $CODE in
              TH) NAME="Thailand" ;; LC) NAME="Saint Lucia" ;; EE) NAME="Estonia" ;;
              MG) NAME="Madagascar" ;; TZ) NAME="Tanzania" ;; BN) NAME="Brunei" ;;
              CG) NAME="Congo" ;; PR) NAME="Puerto Rico" ;; TN) NAME="Tunisia" ;;
              TR) NAME="Turkey" ;; BY) NAME="Belarus" ;; HM) NAME="Heard/McDonald Islands" ;;
              AD) NAME="Andorra" ;; BM) NAME="Bermuda" ;; PT) NAME="Portugal" ;;
              GE) NAME="Georgia" ;; BI) NAME="Burundi" ;; SM) NAME="San Marino" ;;
              NU) NAME="Niue" ;; BB) NAME="Barbados" ;; RU) NAME="Russia" ;;
              GW) NAME="Guinea-Bissau" ;; BD) NAME="Bangladesh" ;; GN) NAME="Guinea" ;;
              CM) NAME="Cameroon" ;; LY) NAME="Libya" ;; MT) NAME="Malta" ;;
              IT) NAME="Italy" ;; HK) NAME="Hong Kong" ;; YE) NAME="Yemen" ;;
              FJ) NAME="Fiji" ;; MM) NAME="Myanmar" ;; YT) NAME="Mayotte" ;;
              CR) NAME="Costa Rica" ;; BV) NAME="Bouvet Island" ;; BA) NAME="Bosnia" ;;
              IR) NAME="Iran" ;; US) NAME="USA" ;; DE) NAME="Germany" ;;
              *) NAME="$CODE" ;;
            esac

            FULL_URL="${REPO_BASE_URL}/$FILE"
            
            # ุงุฌุงุฏ ุฎุท ุจุง ููฺฉ ูุฎู (Download) ู ุญุฐู ูพุดโููุงุด ุจุง ุงุณุชูุงุฏู ุงุฒ < >
            LINE="$EMOJI **$NAME**: [Download List](<$FULL_URL>)"
            
            MESSAGE="${MESSAGE}${LINE}"$'\n'
            COUNT=$((COUNT + 1))

            # ุงุฑุณุงู ุฏุฑ ุฏุณุชูโูุง ฑฐ ุชุง ุจุฑุง ูพุงุฏุงุฑ ุจุดุชุฑ
            if [ $COUNT -eq 10 ] || [ $CURRENT -eq $TOTAL ]; then
              
              # ุงุถุงูู ฺฉุฑุฏู ูุถุนุช ุณุณุชู ุฏุฑ ุงูุชูุง ูุฑ ูพุงู
              MESSAGE="${MESSAGE}"$'\n'"**SYSTEM STATUS:** \`$RANDOM_STATUS\`"
              MESSAGE="${MESSAGE}"$'\n'"------------------------------------"

              jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
              
              # ุจุงุฒูุดุงู ูพุงู ุจุฑุง ุฏุณุชู ุจุนุฏ
              if [ $CURRENT -lt $TOTAL ]; then
                MESSAGE="--- ๐๏ธ **CONTINUED REPORT** ---"$'\n'
              fi
              COUNT=0
              sleep 1.5
            fi
