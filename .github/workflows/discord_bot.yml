name: Country IP Sync & Final Clean Links
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Send Mission Start Header
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          TZ='Asia/Tehran'
          START_TIME=$(date +'%H:%M:%S')
          
          # Ú©Ø¯ Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¨Ø§ Ø§Ø¨Ù‡Øª (ØªØ±Ú©ÛŒØ¨ÛŒ Ø§Ø² Ù¾Ø¯Ø§ÙÙ†Ø¯ Ùˆ Ø¨Ù†Ø² W140)
          CODENAMES=("S400-TRIUMF" "BAVAR-373-CORE" "PATRIOT-STRIKE" "V12-IRON-CLAD" "THOR-RADAR")
          SELECTED_CODE=${CODENAMES[$RANDOM % ${#CODENAMES[@]}]}

          START_MSG="ğŸš€ **NEW OPERATION INITIATED**"$'\n'
          START_MSG+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"$'\n'
          START_MSG+="  ğŸ“¡ **UNIT:** \`Bavar-373-Radar-Station\`"$'\n'
          START_MSG+="  ğŸ›¡ï¸ **CODENAME:** \`$SELECTED_CODE\`"$'\n'
          START_MSG+="  â° **TIME:** \`$START_TIME\`"$'\n'
          START_MSG+="â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"$'\n'
          START_MSG+="*Scanning for Intelligence Data...* ğŸ“¥"

          jq -n --arg msg "$START_MSG" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master || git checkout main
          if git merge upstream/master --ff-only || git merge upstream/main --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin HEAD
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ (ÙÙ‚Ø· IPv4)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find CIDR/ -name "*-ipv4-*" | grep -v "ipv6" | sort)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep "CIDR/" | grep "ipv4" | grep -v "ipv6" || true)
          else
            echo "ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."
            exit 0
          fi

          if [ -z "$FILES" ]; then
            echo "Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."
            exit 0
          fi

          MESSAGE=""
          COUNT=0

          for FILE in $FILES; do
            FILE_NAME=$(basename "$FILE")
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø¯ Ø¯Ùˆ Ø±Ù‚Ù…ÛŒ Ú©Ø´ÙˆØ± (Ù…Ø«Ù„Ø§ TH ÛŒØ§ IR)
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            
            # ØªØ¨Ø¯ÛŒÙ„ Ú©Ø¯ Ú©Ø´ÙˆØ± Ø¨Ù‡ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ù¾Ø±Ú†Ù… (Regional Indicator Symbols)
            # Ø§ÛŒÙ† Ø¨Ø®Ø´ Ú©Ø¯ Ù‡Ú¯Ø² Ú©Ø¯ Ú©Ø´ÙˆØ± Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ…ÙˆØ¬ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            EMOJI=$(python3 -c "print(''.join(chr(127397 + ord(c)) for c in '$CODE'))" 2>/dev/null || echo "ğŸŒ")

            # Ù†Ø§Ù… Ú©Ø´ÙˆØ±Ù‡Ø§ - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø§Ù…Ø§Ù†Ø¯Ù‡ Ø¯Ø± ØªØµÙˆÛŒØ± Ø´Ù…Ø§
            case $CODE in
              TH) NAME="Thailand" ;; LC) NAME="Saint Lucia" ;; EE) NAME="Estonia" ;;
              MG) NAME="Madagascar" ;; TZ) NAME="Tanzania" ;; BN) NAME="Brunei" ;;
              CG) NAME="Congo" ;; PR) NAME="Puerto Rico" ;; TN) NAME="Tunisia" ;;
              TR) NAME="Turkey" ;; BY) NAME="Belarus" ;; HM) NAME="Heard/McDonald Islands" ;;
              AD) NAME="Andorra" ;; BM) NAME="Bermuda" ;; PT) NAME="Portugal" ;;
              GE) NAME="Georgia" ;; BI) NAME="Burundi" ;; SM) NAME="San Marino" ;;
              NU) NAME="Niue" ;; BB) NAME="Barbados" ;; RU) NAME="Russia" ;;
              GW) NAME="Guinea-Bissau" ;; BD) NAME="Bangladesh" ;; GN) NAME="Guinea" ;;
              CM) NAME="Cameroon" ;; LY) NAME="Libya" ;; MT) NAME="Malta" ;;
              IT) NAME="Italy" ;; HK) NAME="Hong Kong" ;; YE) NAME="Yemen" ;;
              FJ) NAME="Fiji" ;; MM) NAME="Myanmar" ;; YT) NAME="Mayotte" ;;
              CR) NAME="Costa Rica" ;; BV) NAME="Bouvet Island" ;; BA) NAME="Bosnia" ;;
              IR) NAME="Iran" ;; US) NAME="USA" ;; DE) NAME="Germany" ;;
              *) NAME="$CODE" ;; # Ø§Ú¯Ø± Ø¯Ø± Ù„ÛŒØ³Øª Ù†Ø¨ÙˆØ¯ Ú©Ø¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
            esac

            FULL_URL="${REPO_BASE_URL}/$FILE"
            LINE="$EMOJI **$NAME**: <$FULL_URL>"
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="$LINE"
            else
              MESSAGE="$MESSAGE"$'\n'"$LINE"
            fi
            
            COUNT=$((COUNT + 1))

            # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ 15 ØªØ§ÛŒÛŒ
            if [ $COUNT -eq 15 ]; then
              jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
              MESSAGE=""
              COUNT=0
              sleep 1 # ÙˆÙ‚ÙÙ‡ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ù„Ø§Ú© Ø´Ø¯Ù† ØªÙˆØ³Ø· Ø¯ÛŒØ³Ú©ÙˆØ±Ø¯
            fi
          done

          # Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
          if [ $COUNT -gt 0 ]; then
            jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi

      - name: Send Final Status & Analytics
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # ØªÙ†Ø¸ÛŒÙ… Ø³Ø§Ø¹Øª Ø¨Ù‡ ÙˆÙ‚Øª Ø§ÛŒØ±Ø§Ù†
          TZ='Asia/Tehran'
          LAST_UPDATE=$(date +'%Y/%m/%d - %H:%M')

          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ (Ù†Ù‡ ÙÙ‚Ø· ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡â€ŒÙ‡Ø§)
          FILES=$(find CIDR/ -name "*-ipv4-*" | grep -v "ipv6" | sort)
          
          # Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø´ÙˆØ±Ù‡Ø§
          COUNTRY_COUNT=$(echo "$FILES" | grep -v '^$' | wc -l)
          
          # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø®Ø·ÙˆØ· (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø±Ù†Ø¬â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒâ€ŒÙ¾ÛŒ)
          TOTAL_IPS=0
          while read -r f; do
            if [ -f "$f" ]; then
              LINES=$(wc -l < "$f")
              TOTAL_IPS=$((TOTAL_IPS + LINES))
            fi
          done <<< "$FILES"

          # Ø¬Ù…Ù„Ø§Øª ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ (Ø±Ù†Ø¯ÙˆÙ… Ù†Ø¸Ø§Ù…ÛŒ)
          FINAL_QUOTES=("Mission Accomplished. Base Secured." "Intelligence Gathering Complete." "All Units Returned to Hangar." "V12 Engine Cooling Down.")
          RANDOM_QUOTE=${FINAL_QUOTES[$RANDOM % ${#FINAL_QUOTES[@]}]}

          # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ
          FINAL_REPORT="ğŸ **IP RANGE FINDING MISSION SUMMARY**"$'\n'
          FINAL_REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"$'\n'
          FINAL_REPORT+="ğŸ“… **Last Update (IRAN-TIME):** \`$LAST_UPDATE\`"$'\n'
          FINAL_REPORT+="ğŸŒ **Total Countries in Database:** \`$COUNTRY_COUNT\`"$'\n'
          FINAL_REPORT+="ğŸ”¢ **Total Active IP Ranges:** \`$TOTAL_IPS\`"$'\n'
          FINAL_REPORT+="ğŸ“ **Operation Status:** \`$RANDOM_QUOTE\`"$'\n'
          FINAL_REPORT+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¯ÛŒØ³Ú©ÙˆØ±Ø¯
          jq -n --arg msg "$FINAL_REPORT" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
