name: Country IP Sync & Multi-Mode Discord

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-send:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Process and Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ุญุงูุช ุฏุณุช: ุงุฑุณุงู ต ูุงู ุงูู..."
            FILES=$(find . -name "*.txt" | grep "CIDR/" | head -n 5)
          elif [[ "$updated" == "true" ]]; then
            echo "ุญุงูุช ุฎูุฏฺฉุงุฑ: ุงุฑุณุงู ุชุบุฑุงุช ุฌุฏุฏ..."
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' || true)
          else
            echo "ุชุบุฑ ุฌุฏุฏ ุงูุช ูุดุฏ."
            exit 0
          fi

          for FILE in $FILES; do
            if [ -f "$FILE" ]; then
              CLEAN_NAME=$(basename "$FILE")
              # ุฎูุงูุฏู ฑต ุฎุท ุงูู ู ุขูุงุฏูโุณุงุฒ ุงูู ุจุฑุง JSON
              CONTENT=$(head -n 15 "$FILE")
              
              echo "ุฏุฑ ุญุงู ุงุฑุณุงู ุงูู: $CLEAN_NAME"
              
              # ุงุณุชูุงุฏู ุงุฒ jq ุจุฑุง ุณุงุฎุชู JSON ุงุณุชุงูุฏุงุฑุฏ ู ุฌููฺฏุฑ ุงุฒ ุฎุทุง 50109
              PAYLOAD=$(jq -n --arg msg "๐ **ูุงู: $CLEAN_NAME**\n\`\`\`\n$CONTENT\n\`\`\`" '{content: $msg}')
              
              curl -H "Content-Type: application/json" \
                   -d "$PAYLOAD" \
                   "$DISCORD_WEBHOOK"
              
              sleep 1
            fi
          done
