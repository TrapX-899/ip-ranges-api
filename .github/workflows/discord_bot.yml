name: Country IP Sync & Final Clean Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find . -name "*-ipv4-Hackers.Zone.txt" | grep "CIDR/" | head -n 80)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' | grep "CIDR/" | grep -v "ipv6" || true)
          else
            echo "تغییری یافت نشد."
            exit 0
          fi

          MESSAGE=""
          COUNT=0
          MAX_PER_MESSAGE=10

          for FILE in $FILES; do
            FILE_NAME=$(basename "$FILE")
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')

            # نام کشورها
            declare -A COUNTRY_NAMES=(
              [TH]="Thailand" [LC]="Saint Lucia" [EE]="Estonia" [MG]="Madagascar" [TZ]="Tanzania"
              [BN]="Brunei" [CG]="Republic of the Congo" [PR]="Puerto Rico" [TN]="Tunisia" [TR]="Turkey"
              [BY]="Belarus" [HM]="Heard Island" [AD]="Andorra" [BM]="Bermuda" [PT]="Portugal"
              [GE]="Georgia" [BI]="Burundi" [SM]="San Marino" [NU]="Niue" [BB]="Barbados"
              [RU]="Russia" [GW]="Guinea-Bissau" [BD]="Bangladesh" [GN]="Guinea" [CM]="Cameroon"
              [LY]="Libya" [MT]="Malta" [IT]="Italy" [HK]="Hong Kong" [YE]="Yemen"
              [FJ]="Fiji" [MM]="Myanmar" [YT]="Mayotte" [CR]="Costa Rica" [GH]="Ghana" [BA]="Bosnia and Herzegovina"
            )

            NAME=${COUNTRY_NAMES[$CODE]:-$CODE}

            # ایموجی پرچم کشور
            EMOJI=$(echo $CODE | awk '{printf "\\U1F1%s\\U1F1%s", substr($0,1,1), substr($0,2,1)}' | xargs -0 printf)

            FULL_URL="${REPO_BASE_URL}/CIDR/${FILE_NAME}"
            LINE="$EMOJI **$NAME**: <$FULL_URL>"

            MESSAGE="$MESSAGE"$'\n'"$LINE"
            COUNT=$((COUNT + 1))

            if [ $COUNT -eq $MAX_PER_MESSAGE ]; then
              jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
              MESSAGE=""
              COUNT=0
              sleep 2
            fi
          done

          if [ $COUNT -gt 0 ]; then
            jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
