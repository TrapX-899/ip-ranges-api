name: Country IP Sync & Optimized Discord Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

- name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          # ุฏุงูููุฏ ูุงู ูุงู ฺฉุดูุฑูุง ุจุฑุง ุชุจุฏู ฺฉุฏ ุจู ูุงู ฺฉุงูู
          curl -s https://raw.githubusercontent.com/umpirsky/country-list/master/data/fa/country.json -o countries.json

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find . -name "*.txt" | grep "CIDR/" | grep -v "ipv6" | head -n 100)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' | grep -v "ipv6" || true)
          else
            echo "ุชุบุฑ ุฌุฏุฏ ุงูุช ูุดุฏ."
            exit 0
          fi

          MESSAGE_BATCH=""
          COUNT=0

          for FILE in $FILES; do
            FILE_NAME=$(basename "$FILE")
            # ุงุณุชุฎุฑุงุฌ ฺฉุฏ ฺฉุดูุฑ (ูุซูุง IR)
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            
            # ูพุฏุง ฺฉุฑุฏู ูุงู ูุงุฑุณ ฺฉุดูุฑ ุงุฒ ูุงู ุฏุงูููุฏ ุดุฏู
            COUNTRY_NAME=$(jq -r --arg code "$CODE" '.[$code] // $code' countries.json)
            
            FULL_URL="${REPO_BASE_URL}/CIDR/${FILE_NAME}"
            
            # ุณุงุฎุช ุฎุท ูพุงู (ุจุฏูู ุงุณุชูุงุฏู ุงุฒ \n ุฏุณุช ุฏุฑ ูุชู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุจุงฺฏ ุชุตูุฑ ุดูุง)
            LINE="๐ **$COUNTRY_NAME**: [ูุดุงูุฏู ูุณุช]($FULL_URL)"
            
            if [ -z "$MESSAGE_BATCH" ]; then
              MESSAGE_BATCH="$LINE"
            else
              MESSAGE_BATCH="$MESSAGE_BATCH
$LINE"
            fi
            
            COUNT=$((COUNT + 1))

            # ุงุฑุณุงู ุฏุฑ ุฏุณุชูโูุง ฑฐ ุชุง
            if [ $COUNT -eq 10 ]; then
              PAYLOAD=$(jq -n --arg msg "$MESSAGE_BATCH" '{content: $msg}')
              curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
              MESSAGE_BATCH=""
              COUNT=0
              sleep 2
            fi
          done

          # ุงุฑุณุงู ุจุงูโูุงูุฏู
          if [ $COUNT -gt 0 ]; then
            PAYLOAD=$(jq -n --arg msg "$MESSAGE_BATCH" '{content: $msg}')
            curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
          fi
