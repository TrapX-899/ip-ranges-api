name: Country IP Sync & Final Optimized Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          # ุงูุชุฎุงุจ ูุงูโูุง ู ุญุฐู ipv6
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ุญุงูุช ุฏุณุช ูุนุงู ุดุฏ."
            FILES=$(find . -name "*.txt" | grep "CIDR/" | grep -v "ipv6" | head -n 60)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' | grep -v "ipv6" || true)
          else
            echo "ุชุบุฑ ุฌุฏุฏ ุงูุช ูุดุฏ."
            exit 0
          fi

          if [ -z "$FILES" ]; then
             echo "ูุงู ุจุฑุง ุงุฑุณุงู ูุณุช."
             exit 0
          fi

          MESSAGE=""
          COUNT=0

          for FILE in $FILES; do
            FILE_NAME=$(basename "$FILE")
            # ุงุณุชุฎุฑุงุฌ ฺฉุฏ ฺฉุดูุฑ ู ุชุจุฏู ุจู ุญุฑูู ุจุฒุฑฺฏ
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            
            FULL_URL="${REPO_BASE_URL}/CIDR/${FILE_NAME}"
            
            # ุงูุฒูุฏู ุฎุท ุฌุฏุฏ ุจู ูพุงู
            LINE="๐ **ฺฉุดูุฑ $CODE**: [ูุดุงูุฏู ูุณุช ุขโูพ]($FULL_URL)"
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="$LINE"
            else
              MESSAGE="$MESSAGE"$'\n'"$LINE"
            fi
            
            COUNT=$((COUNT + 1))

            # ุงุฑุณุงู ุฏุฑ ุฏุณุชูโูุง ฑฐ ุชุง ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุณูฺฏู ุดุฏู ูพุงู
            if [ $COUNT -eq 10 ]; then
              jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
              MESSAGE=""
              COUNT=0
              sleep 2
            fi
          done

          # ุงุฑุณุงู ุจุงูโูุงูุฏู ููฺฉโูุง
          if [ $COUNT -gt 0 ]; then
            jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
