name: Country IP Sync & Final Clean Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with original repository
        run: |
          set -e
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> "$GITHUB_ENV"
            git push origin master
          else
            echo "updated=false" >> "$GITHUB_ENV"
          fi

      - name: Send grouped links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: https://github.com/${{ github.repository }}/blob/master
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -e

          # Pick files: only IPv4 inside CIDR
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            FILES=$(find . -type f -name "*-ipv4-Hackers.Zone.txt" | grep "CIDR/" | sort | head -n 80)
          elif [[ "${updated:-false}" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep "CIDR/" | grep -E '\-ipv4\-Hackers\.Zone\.txt$' || true)
          else
            echo "No changes detected."
            exit 0
          fi

          if [[ -z "$FILES" ]]; then
            echo "No eligible IPv4 files found to send."
            exit 0
          fi

          # Country names dictionary
          declare -A COUNTRY_NAMES=(
            [AF]="Afghanistan" [AL]="Albania" [DZ]="Algeria" [AD]="Andorra" [AO]="Angola" [AR]="Argentina" [AM]="Armenia"
            [AU]="Australia" [AT]="Austria" [AZ]="Azerbaijan" [BH]="Bahrain" [BD]="Bangladesh" [BY]="Belarus"
            [BE]="Belgium" [BR]="Brazil" [BG]="Bulgaria" [CA]="Canada" [CN]="China" [CO]="Colombia" [HR]="Croatia"
            [CU]="Cuba" [CY]="Cyprus" [CZ]="Czech Republic" [DK]="Denmark" [EG]="Egypt" [FI]="Finland" [FR]="France"
            [GE]="Georgia" [DE]="Germany" [GR]="Greece" [HK]="Hong Kong" [HU]="Hungary" [IS]="Iceland" [IN]="India"
            [ID]="Indonesia" [IR]="Iran" [IQ]="Iraq" [IE]="Ireland" [IT]="Italy" [JP]="Japan" [JO]="Jordan"
            [KZ]="Kazakhstan" [KW]="Kuwait" [LB]="Lebanon" [LY]="Libya" [MY]="Malaysia" [MX]="Mexico" [MC]="Monaco"
            [MA]="Morocco" [NL]="Netherlands" [NZ]="New Zealand" [NO]="Norway" [OM]="Oman" [PK]="Pakistan"
            [PS]="Palestine" [PH]="Philippines" [PL]="Poland" [PT]="Portugal" [QA]="Qatar" [RO]="Romania" [RU]="Russia"
            [SA]="Saudi Arabia" [SG]="Singapore" [KR]="South Korea" [ES]="Spain" [SE]="Sweden" [CH]="Switzerland"
            [SY]="Syria" [TW]="Taiwan" [TH]="Thailand" [TR]="Turkey" [UA]="Ukraine" [AE]="United Arab Emirates"
            [GB]="United Kingdom" [US]="USA" [VN]="Vietnam" [YE]="Yemen" [LC]="Saint Lucia" [EE]="Estonia"
            [MG]="Madagascar" [TZ]="Tanzania" [BN]="Brunei" [CG]="Republic of the Congo" [PR]="Puerto Rico"
            [TN]="Tunisia" [HM]="Heard Island and McDonald Islands" [BM]="Bermuda" [BI]="Burundi"
            [SM]="San Marino" [NU]="Niue" [BB]="Barbados" [GW]="Guinea-Bissau" [GN]="Guinea" [CM]="Cameroon"
            [MT]="Malta" [FJ]="Fiji" [MM]="Myanmar" [YT]="Mayotte" [CR]="Costa Rica" [GH]="Ghana" [BA]="Bosnia and Herzegovina"
          )

          # Flag emoji via Python one-liner (no heredoc)
          flag_emoji() {
            local code="$1"
            python3 -c 'import sys; c=sys.argv[1].strip().upper()
if len(c)!=2 or not c.isalpha(): print("ðŸ³ï¸"); exit(0)
base=0x1F1E6
print(chr(base+(ord(c[0])-65))+chr(base+(ord(c[1])-65)))' "$code"
          }

          send_chunk() {
            local chunk="$1"
            jq -n --arg msg "$chunk" '{content: $msg}' | \
              curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK" >/dev/null
          }

          MESSAGE=""
          COUNT=0
          MAX_PER_MESSAGE=10

          while IFS= read -r FILE; do
            FILE_NAME=$(basename "$FILE")
            CODE=$(echo "$FILE_NAME" | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            NAME=${COUNTRY_NAMES[$CODE]:-$CODE}
            EMOJI=$(flag_emoji "$CODE")
            FULL_URL="${REPO_BASE_URL}/CIDR/${FILE_NAME}"
            LINE="$EMOJI **$NAME**: <${FULL_URL}>"

            if [[ -z "$MESSAGE" ]]; then
              MESSAGE="$LINE"
            else
              MESSAGE="$MESSAGE"$'\n'"$LINE"
            fi

            COUNT=$((COUNT + 1))
            if [[ $COUNT -ge $MAX_PER_MESSAGE ]]; then
              send_chunk "$MESSAGE"
              MESSAGE=""
              COUNT=0
              sleep 2
            fi
          done <<< "$FILES"

          if [[ $COUNT -gt 0 ]]; then
            send_chunk "$MESSAGE"
          fi

          echo "Discord messages sent successfully."
