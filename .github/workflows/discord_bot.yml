name: Sync Country IP Ranges to Discord

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-and-notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with ebrasha/cidr-ip-ranges
        run: |
          # ØªÙ†Ø¸ÛŒÙ… Ù‡ÙˆÛŒØª Ø¨Ø±Ø§ÛŒ Ú¯ÛŒØª (Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Merge)
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git
          git fetch upstream
          
          # ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø§Ø² main Ø¨Ù‡ master Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒÙ¾Ø§Ø²ÛŒØªÙˆØ±ÛŒ Ø´Ù…Ø§
          git checkout master
          
          if git merge upstream/master --ff-only; then
            echo "sync_status=updated" >> $GITHUB_ENV
            git push origin master
          else
            echo "sync_status=no_change" >> $GITHUB_ENV
          fi

      - name: Send Updates to Discord
        if: env.sync_status == 'updated'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª
          CHANGED_FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "ØªØºÛŒÛŒØ± Ù…Ø­ØªÙˆØ§ÛŒÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."
            exit 0
          fi

          for FILE in $CHANGED_FILES; do
            if [ -f "$FILE" ]; then
              CONTENT=$(head -n 15 "$FILE")
              FILE_NAME=$(basename "$FILE")
              
              curl -H "Content-Type: application/json" \
                   -d "{\"content\": \"ğŸš© **ØªØºÛŒÛŒØ± Ø¯Ø± Ø±Ù†Ø¬ Ø¢ÛŒâ€ŒÙ¾ÛŒ: $FILE_NAME**\n\`\`\`\n$CONTENT\n\`\`\`\"}" \
                   $DISCORD_WEBHOOK
            fi
          done
