name: Country IP Sync & Multi-Mode Discord

on:
  schedule:
    - cron: '0 * * * *' # ุงุฌุฑุง ุฎูุฏฺฉุงุฑ ุณุฑ ูุฑ ุณุงุนุช
  workflow_dispatch: # ุฏฺฉูู ุงุฌุฑุง ุฏุณุช

jobs:
  sync-and-send:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git
          git fetch upstream
          git checkout master
          
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Process and Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # ุชุดุฎุต ููุน ุงุฌุฑุง
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ุญุงูุช ุงุฌุฑุง ุฏุณุช: ุงุฑุณุงู ุชูุงู ูุงูโูุง..."
            # ูพุฏุง ฺฉุฑุฏู ุชูุงู ูุงูโูุง txt (ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุณูพู ุณูฺฏูุ 10 ูุงู ุงูู ุฑุง ูโูุฑุณุชุฏ)
            FILES=$(find . -name "*.txt" | head -n 10)
          elif [[ "$updated" == "true" ]]; then
            echo "ุญุงูุช ุฎูุฏฺฉุงุฑ: ุงุฑุณุงู ุชุบุฑุงุช ุฌุฏุฏ..."
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' || true)
          else
            echo "ูฺ ุชุบุฑ ุฌุฏุฏ ุงูุช ูุดุฏ ู ุงุฌุฑุง ุฏุณุช ูุจูุฏ."
            exit 0
          fi

          if [ -z "$FILES" ]; then
            echo "ูุงู ุจุฑุง ุงุฑุณุงู ูพุฏุง ูุดุฏ."
            exit 0
          fi

          for FILE in $FILES; do
            if [ -f "$FILE" ]; then
              CONTENT=$(head -n 15 "$FILE")
              FILE_NAME=$(basename "$FILE")
              
              echo "ุฏุฑ ุญุงู ุงุฑุณุงู: $FILE_NAME"
              
              curl -H "Content-Type: application/json" \
                   -d "{\"content\": \"๐ **ูุงู: $FILE_NAME**\n\`\`\`\n$CONTENT\n\`\`\`\"}" \
                   $DISCORD_WEBHOOK
              
              # ุงุฌุงุฏ ูููู ฺฉูุชุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ Rate Limit ุฏุณฺฉูุฑุฏ
              sleep 1
            fi
          done
