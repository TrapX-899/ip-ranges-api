name: Country IP Sync & Optimized Discord Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          # ูพุฏุง ฺฉุฑุฏู ูุงูโูุง ู ููุชุฑ ฺฉุฑุฏู IPv6
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find . -name "*.txt" | grep "CIDR/" | grep -v "ipv6" | head -n 50)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' | grep -v "ipv6" || true)
          else
            echo "ุชุบุฑ ุฌุฏุฏ ุงูุช ูุดุฏ."
            exit 0
          fi

          MESSAGE_BATCH=""
          COUNT=0

          for FILE in $FILES; do
            CLEAN_PATH=$(echo $FILE | sed 's|./||')
            FILE_NAME=$(basename "$FILE")
            
            # ุงุณุชุฎุฑุงุฌ ฺฉุฏ ฺฉุดูุฑ (ูุซูุงู IR ุง AE)
            COUNTRY_CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            
            # ุฏฺฉุดูุฑ ูุงู ฺฉุดูุฑูุง (ูโุชูุงูุฏ ููุงุฑุฏ ุจุดุชุฑ ุงุถุงูู ฺฉูุฏ)
            case $COUNTRY_CODE in
              IR) FULL_NAME="ุงุฑุงู ๐ฎ๐ท" ;;
              AE) FULL_NAME="ุงูุงุฑุงุช ๐ฆ๐ช" ;;
              DE) FULL_NAME="ุขููุงู ๐ฉ๐ช" ;;
              US) FULL_NAME="ุขูุฑฺฉุง ๐บ๐ธ" ;;
              TR) FULL_NAME="ุชุฑฺฉู ๐น๐ท" ;;
              GB) FULL_NAME="ุงูฺฏูุณ ๐ฌ๐ง" ;;
              *) FULL_NAME="$COUNTRY_CODE" ;;
            esac

            FULL_URL="${REPO_BASE_URL}/${CLEAN_PATH}"
            LINE="๐ **$FULL_NAME**: [ูุดุงูุฏู ูุณุช]($FULL_URL)\n"
            MESSAGE_BATCH="${MESSAGE_BATCH}${LINE}"
            COUNT=$((COUNT + 1))

            # ูุฑ ฑฐ ููฺฉ ุฑุง ุฏุฑ ฺฉ ูพุงู ุจูุฑุณุช
            if [ $COUNT -eq 10 ]; then
              PAYLOAD=$(jq -n --arg msg "$MESSAGE_BATCH" '{content: $msg}')
              curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
              MESSAGE_BATCH=""
              COUNT=0
              sleep 2
            fi
          done

          # ุงุฑุณุงู ุจุงูโูุงูุฏู ููฺฉโูุง
          if [ $COUNT -gt 0 ]; then
            PAYLOAD=$(jq -n --arg msg "$MESSAGE_BATCH" '{content: $msg}')
            curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
          fi
