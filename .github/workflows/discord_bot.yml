name: Country IP Sync & Final Clean Links

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-and-link:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Sync with Original Repository
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/ebrasha/cidr-ip-ranges-by-country.git || true
          git fetch upstream
          git checkout master
          if git merge upstream/master --ff-only; then
            echo "updated=true" >> $GITHUB_ENV
            git push origin master
          else
            echo "updated=false" >> $GITHUB_ENV
          fi

      - name: Send Grouped Links to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO_BASE_URL: "https://github.com/${{ github.repository }}/blob/master"
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FILES=$(find . -name "*.txt" | grep "CIDR/" | grep -v "ipv6" | head -n 80)
          elif [[ "$updated" == "true" ]]; then
            FILES=$(git diff --name-only HEAD@{1} HEAD | grep '\.txt$' | grep -v "ipv6" || true)
          else
            echo "ÿ™ÿ∫€å€åÿ± ÿ¨ÿØ€åÿØ€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ."
            exit 0
          fi

          MESSAGE=""
          COUNT=0

          for FILE in $FILES; do
            FILE_NAME=$(basename "$FILE")
            CODE=$(echo $FILE_NAME | cut -d'-' -f1 | tr '[:lower:]' '[:upper:]')
            
            # ÿØ€å⁄©ÿ¥ŸÜÿ±€å ŸÜÿßŸÖ ⁄©ÿ¥Ÿàÿ±Ÿáÿß (ŸÜÿ≥ÿÆŸá ÿßŸÜ⁄ØŸÑ€åÿ≥€å ÿ®ÿ±ÿß€å ŸæŸàÿ¥ÿ¥ ⁄©ÿßŸÖŸÑ)
            case $CODE in
              AF) NAME="Afghanistan" ;; AL) NAME="Albania" ;; DZ) NAME="Algeria" ;; AD) NAME="Andorra" ;; AO) NAME="Angola" ;;
              AR) NAME="Argentina" ;; AM) NAME="Armenia" ;; AU) NAME="Australia" ;; AT) NAME="Austria" ;; AZ) NAME="Azerbaijan" ;;
              BH) NAME="Bahrain" ;; BD) NAME="Bangladesh" ;; BY) NAME="Belarus" ;; BE) NAME="Belgium" ;; BR) NAME="Brazil" ;;
              BG) NAME="Bulgaria" ;; CA) NAME="Canada" ;; CN) NAME="China" ;; CO) NAME="Colombia" ;; HR) NAME="Croatia" ;;
              CU) NAME="Cuba" ;; CY) NAME="Cyprus" ;; CZ) NAME="Czech Republic" ;; DK) NAME="Denmark" ;; EG) NAME="Egypt" ;;
              FI) NAME="Finland" ;; FR) NAME="France" ;; GE) NAME="Georgia" ;; DE) NAME="Germany" ;; GR) NAME="Greece" ;;
              HK) NAME="Hong Kong" ;; HU) NAME="Hungary" ;; IS) NAME="Iceland" ;; IN) NAME="India" ;; ID) NAME="Indonesia" ;;
              IR) NAME="Iran" ;; IQ) NAME="Iraq" ;; IE) NAME="Ireland" ;; IT) NAME="Italy" ;; JP) NAME="Japan" ;;
              JO) NAME="Jordan" ;; KZ) NAME="Kazakhstan" ;; KW) NAME="Kuwait" ;; LB) NAME="Lebanon" ;; LY) NAME="Libya" ;;
              MY) NAME="Malaysia" ;; MX) NAME="Mexico" ;; MC) NAME="Monaco" ;; MA) NAME="Morocco" ;; NL) NAME="Netherlands" ;;
              NZ) NAME="New Zealand" ;; NO) NAME="Norway" ;; OM) NAME="Oman" ;; PK) NAME="Pakistan" ;; PS) NAME="Palestine" ;;
              PH) NAME="Philippines" ;; PL) NAME="Poland" ;; PT) NAME="Portugal" ;; QA) NAME="Qatar" ;; RO) NAME="Romania" ;;
              RU) NAME="Russia" ;; SA) NAME="Saudi Arabia" ;; SG) NAME="Singapore" ;; KR) NAME="South Korea" ;; ES) NAME="Spain" ;;
              SE) NAME="Sweden" ;; CH) NAME="Switzerland" ;; SY) NAME="Syria" ;; TW) NAME="Taiwan" ;; TH) NAME="Thailand" ;;
              TR) NAME="Turkey" ;; UA) NAME="Ukraine" ;; AE) NAME="United Arab Emirates" ;; GB) NAME="United Kingdom" ;; US) NAME="USA" ;;
              VN) NAME="Vietnam" ;; YE) NAME="Yemen" ;; *) NAME="$CODE" ;;
            esac

            FULL_URL="${REPO_BASE_URL}/CIDR/${FILE_NAME}"
            
            # ŸÇÿ±ÿßÿ± ÿØÿßÿØŸÜ ŸÑ€åŸÜ⁄© ÿØÿßÿÆŸÑ <> ÿ®ÿ±ÿß€å ÿ≠ÿ∞ŸÅ Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥ (No Embed)
            LINE="üåê **$NAME**: <$FULL_URL>"
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="$LINE"
            else
              MESSAGE="$MESSAGE"$'\n'"$LINE"
            fi
            
            COUNT=$((COUNT + 1))

            if [ $COUNT -eq 10 ]; then
              jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
              MESSAGE=""
              COUNT=0
              sleep 2
            fi
          done

          if [ $COUNT -gt 0 ]; then
            jq -n --arg msg "$MESSAGE" '{content: $msg}' | curl -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
